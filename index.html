<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ - Ù…Ù„Ù Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</title>

  <style>
    :root {
      --bg: #0f172a;
      --fg: #e2e8f0;
      --panel: #1e293b;
      --accent: #3b82f6;
      --border: #334155;
      --danger: #ef4444;
      --success: #22c55e;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: "Tajawal", sans-serif;
    }

    header {
      background: var(--panel);
      padding: 16px;
      text-align: center;
      font-size: 22px;
      border-bottom: 1px solid var(--border);
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 16px;
    }

    .criteria-box {
      background: var(--panel);
      margin-bottom: 20px;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .criteria-title {
      font-size: 20px;
      margin-bottom: 6px;
    }

    .criteria-subtitle {
      font-size: 14px;
      margin-bottom: 12px;
      color: #94a3b8;
    }

    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      color: #94a3b8;
      margin-bottom: 14px;
    }

    .thumbs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .thumbs img {
      width: 110px;
      height: 110px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .generate-btn {
      margin-top: 30px;
      display: block;
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      background: var(--accent);
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
    }

    .popup-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(15,23,42,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .popup-box {
      background: var(--panel);
      width: 380px;
      padding: 20px;
      border-radius: 16px;
      border: 1px solid var(--border);
    }

    .popup-box h3 {
      margin: 0 0 12px;
      font-size: 19px;
    }

    .popup-box input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f172a;
      color: var(--fg);
      margin-bottom: 16px;
      font-size: 16px;
    }

    .popup-box button {
      width: 100%;
      padding: 12px;
      font-size: 17px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    .loading {
      display: none;
      margin-top: 10px;
      padding: 12px;
      background: var(--panel);
      border-radius: 10px;
      text-align: center;
      border: 1px solid var(--border);
      color: #a5b4fc;
    }
  </style>
</head>

<body>

<header>ğŸ” Ø±ÙØ¹ Ø´ÙˆØ§Ù‡Ø¯ Ù…Ù„Ù Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø®ØµØµ Ù„Ùƒ</header>

<div class="container" id="criteriaContainer">

  <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ù‡Ù†Ø§ Ø¹Ø¨Ø± JavaScript -->

</div>

<button class="generate-btn" onclick="startGeneration()">
  ğŸš€ ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
</button>

<div class="loading" id="loadingBox">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±â€¦</div>

<!-- Popup Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… -->
<div class="popup-overlay" id="teacherPopup">
  <div class="popup-box">
    <h3>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
    <input type="text" id="teacherNameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ù‡Ù†Ø§">
    <button onclick="confirmTeacherName()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
  </div>
</div>

<script>
  const CLOUD_NAME = "dayqxxloc";
  const UPLOAD_PRESET = "saud_preset";

  const CRITERIA = [
    { id: 1, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„",   subtitle: "Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ©" },
    { id: 2, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ",  subtitle: "Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ù…Ù‡Ù†ÙŠ" },
    { id: 3, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«",  subtitle: "Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±" },
    { id: 4, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹",  subtitle: "Ø§Ù„ØªÙ†ÙˆÙŠØ¹ ÙÙŠ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³" },
    { id: 5, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø®Ø§Ù…Ø³",  subtitle: "ØªØ­Ø³ÙŠÙ† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ†" },
    { id: 6, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¯Ø³",  subtitle: "Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªÙ†ÙÙŠØ° Ø®Ø·Ø© Ø§Ù„ØªØ¹Ù„Ù…" },
    { id: 7, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¨Ø¹",  subtitle: "ØªÙˆØ¸ÙŠÙ ØªÙ‚Ù†ÙŠØ§Øª ÙˆÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©" },
    { id: 8, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù…Ù†",  subtitle: "ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©" },
    { id: 9, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„ØªØ§Ø³Ø¹",  subtitle: "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙŠØ©" },
    { id: 10, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ø´Ø±", subtitle: "ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ† ÙˆØªØ´Ø®ÙŠØµ Ù…Ø³ØªÙˆÙŠØ§ØªÙ‡Ù…" },
    { id: 11, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±", subtitle: "ØªÙ†ÙˆØ¹ Ø£Ø³Ø§Ù„ÙŠØ¨ ÙˆØ£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ‚ÙˆÙŠÙ…" },
    { id: 12, title: "Ù…Ù†Ø¬Ø²Ø§Øª Ø£Ø®Ø±Ù‰", subtitle: "Ù…Ù†Ø¬Ø²Ø§Øª Ø£Ø®Ø±Ù‰ Ø®Ù„Ø§Ù„ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ 1447 Ù‡Ù€" }
  ];

  const state = {
    teacherName: "",
    files: {}     // { 1: [File,File], 2:[...], ... }
  };

  function buildUI() {
    const container = document.getElementById("criteriaContainer");
    container.innerHTML = "";

    CRITERIA.forEach(c => {
      const box = document.createElement("div");
      box.className = "criteria-box";

      box.innerHTML = `
        <div class="criteria-title">${c.title}</div>
        <div class="criteria-subtitle">${c.subtitle}</div>

        <div class="upload-area" onclick="pickFiles(${c.id})" id="upload${c.id}">
          Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø´ÙˆØ§Ù‡Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±
        </div>

        <div class="thumbs" id="thumbs${c.id}"></div>
      `;

      container.appendChild(box);
    });
  }
function pickFiles(id) {
    const input = document.createElement("input");
    input.type = "file";
    input.multiple = true;
    input.accept = "image/*";

    input.onchange = () => {
      const files = Array.from(input.files || []);
      if (!state.files[id]) state.files[id] = [];

      state.files[id].push(...files);
      renderThumbs(id);
    };

    input.click();
  }

  function renderThumbs(id) {
    const div = document.getElementById("thumbs" + id);
    div.innerHTML = "";

    (state.files[id] || []).forEach(file => {
      const url = URL.createObjectURL(file);
      const img = document.createElement("img");
      img.src = url;
      div.appendChild(img);
    });
  }

  function startGeneration() {
    document.getElementById("teacherPopup").style.display = "flex";
  }

  function confirmTeacherName() {
    const name = document.getElementById("teacherNameInput").value.trim();
    if (!name) {
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù….");
      return;
    }
    state.teacherName = name;

    document.getElementById("teacherPopup").style.display = "none";
    generateAndDownload();
  }

  async function uploadSingleFile(file) {
    const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;
    const formData = new FormData();

    formData.append("file", file);
    formData.append("upload_preset", UPLOAD_PRESET);

    const res = await fetch(url, { method: "POST", body: formData });
    if (!res.ok) {
      const t = await res.text();
      throw new Error("Cloudinary image upload error: " + t);
    }

    const data = await res.json();
    return data.secure_url || data.url;
  }

  // Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© HTML Ø¨Ø³ÙŠØ·Ø© Ù„ÙƒÙ„ Ù…Ø¹ÙŠØ§Ø± (Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… + Ø§Ù„Ù…Ø¹ÙŠØ§Ø± + Ø§Ù„ØµÙˆØ±)
  function buildCriterionHtml(teacherName, crit, imageUrls) {
    const esc = (s) =>
      String(s || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");

    const title = esc(crit.title);
    const subtitle = esc(crit.subtitle);
    const tName = esc(teacherName);

    const imgsHtml = imageUrls
      .map((url) => {
        const u = esc(url);
        return `<div class="img-box"><img src="${u}" alt="Ø´Ø§Ù‡Ø¯ Ù…Ø¹ÙŠØ§Ø±" loading="lazy"></div>`;
      })
      .join("\n");

    return `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø´ÙˆØ§Ù‡Ø¯ ${title} - ${tName}</title>
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, "Tajawal", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }
    .wrap {
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 6px;
    }
    h2 {
      font-size: 16px;
      font-weight: 400;
      margin: 0 0 16px;
      color: #9ca3af;
    }
    .meta {
      font-size: 13px;
      margin-bottom: 18px;
      color: #9ca3af;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }
    .img-box {
      background: #020617;
      border-radius: 12px;
      padding: 6px;
      border: 1px solid rgba(148, 163, 184, 0.45);
    }
    .img-box img {
      width: 100%;
      border-radius: 10px;
      display: block;
      max-height: 420px;
      object-fit: contain;
      background: #020617;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Ø´ÙˆØ§Ù‡Ø¯ ${title}</h1>
    <h2>${subtitle}</h2>
    <div class="meta">Ø§Ù„Ù…Ø¹Ù„Ù…: ${tName}</div>
    <div class="grid">
      ${imgsHtml}
    </div>
  </div>
</body>
</html>`;
  }

  async function uploadHtmlPage(htmlContent, publicIdHint) {
    const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/raw/upload`;
    const blob = new Blob([htmlContent], {
      type: "text/html;charset=utf-8",
    });
    const formData = new FormData();
    formData.append("file", blob);
    formData.append("upload_preset", UPLOAD_PRESET);

    if (publicIdHint) {
      formData.append("public_id", publicIdHint);
    }

    const res = await fetch(url, { method: "POST", body: formData });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error("Cloudinary HTML upload error: " + txt);
    }
    const data = await res.json();
    return data.secure_url || data.url;
  }

  function slugifyForId(name) {
    const base = String(name || "")
      .trim()
      .toLowerCase()
      .replace(/\s+/g, "_");

    return base.replace(/[^a-z0-9_\-]+/g, "") || "teacher";
  }

  async function generateAndDownload() {
    document.getElementById("loadingBox").style.display = "block";
    const PptxGenJS = window.PptxGenJS;
    const pres = new PptxGenJS();
pres.layout = "LAYOUT_WIDE";

    const templateUrl = "template.pptx";
    const resp = await fetch(templateUrl);
    const templateArrayBuffer = await resp.arrayBuffer();
    pres.load(templateArrayBuffer);

    const allSlides = pres.slides;

    const firstSlide = allSlides[0];
    firstSlide.addText(`Ø§Ù„Ù…Ø¹Ù„Ù…: ${state.teacherName}`, {
      x: 1,
      y: 1.2,
      fontSize: 22,
      fontFace: "Arial",
      color: "000000",
    });

    const albumsInfo = {};

    for (const crit of CRITERIA) {
      const arr = state.files[crit.id] || [];
      if (arr.length === 0) continue;

      const imgUrls = [];
      for (const f of arr) {
        const u = await uploadSingleFile(f);
        imgUrls.push(u);
      }

      const critMeta =
        CRITERIA.find((c) => c.id === crit.id) || {
          title: `Ø§Ù„Ù…Ø¹ÙŠØ§Ø± ${crit.id}`,
          subtitle: "",
        };

      const htmlContent = buildCriterionHtml(state.teacherName, critMeta, imgUrls);

      const teacherSlug = slugifyForId(state.teacherName);
      const publicId = `html_${teacherSlug}_c${crit.id}_${Date.now()}`;

      const pageUrl = await uploadHtmlPage(htmlContent, publicId);

      const qrInfo = await generateQRBinary(pageUrl);

      albumsInfo[crit.id] = {
        pageUrl,
        qrBytes: qrInfo.bytes,
        qrDataURL: qrInfo.dataURL,
      };
    }

    for (const crit of CRITERIA) {
      const info = albumsInfo[crit.id];
      if (!info) continue;

      const slideIndex = crit.id;
      const slideObj = allSlides[slideIndex];
      if (!slideObj) continue;

      const qrImage = info.qrDataURL;
      slideObj.addImage({
        data: qrImage,
        x: 1.0,
        y: 1.3,
        w: 2.6,
        h: 2.6,
      });

      slideObj.addText(info.pageUrl, {
        x: 1.0,
        y: 4.0,
        w: 7.0,
        h: 0.6,
        fontSize: 12,
        fontFace: "Arial",
        color: "000000",
      });
    }

    pres.writeFile({
      fileName: "Ù…Ù„Ù Ø¥Ù†Ø¬Ø§Ø² - " + state.teacherName + ".pptx",
    });

    document.getElementById("loadingBox").style.display = "none";
  }

  async function generateQRBinary(text) {
    return new Promise((resolve, reject) => {
      QRCode.toDataURL(
        text,
        {
          errorCorrectionLevel: "L",
          margin: 0,
          scale: 6,
        },
        (err, url) => {
          if (err) return reject(err);

          const byteString = atob(url.split(",")[1]);
          const bytes = new Uint8Array(byteString.length);
          for (let i = 0; i < byteString.length; i++) {
            bytes[i] = byteString.charCodeAt(i);
          }

          resolve({
            dataURL: url,
            bytes,
          });
        }
      );
    });
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.11.0/dist/pptxgen.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script>
  buildUI();
</script>

</body>
</html>
