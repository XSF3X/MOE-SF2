<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ</title>
    <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ">
    <meta name="application-name" content="Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ">
    <link rel="icon" href="teacher_logo.png">
    <link rel="apple-touch-icon" href="teacher_logo.png">


  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <style>
    :root { --primary: #0ea5e9; --bg-main: #f8fafc; --text-main: #0f172a; --border: #e2e8f0; }
    * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
    body { margin: 0; background: var(--bg-main); color: var(--text-main); min-height: 100vh; padding-bottom: 50px; }
    header { background: #fff; border-bottom: 1px solid var(--border); padding: 15px 20px; position: sticky; top: 0; z-index: 50; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
    .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand img { width: 48px; height: 48px; border-radius: 12px; object-fit: cover; background: #f1f5f9; padding: 4px; border: 1px solid var(--border); }
    .brand-text h1 { margin: 0; font-size: 20px; font-weight: 800; color: var(--text-main); }
    .user-info { background: #f1f5f9; padding: 8px 16px; border-radius: 30px; font-size: 13px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border); }
    .logout-btn { background: #fee2e2; color: #dc2626; border: none; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .logout-btn:hover { background: #fecaca; }
    .app-container { max-width: 1200px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: 2fr 1.2fr; gap: 25px; }
    @media (max-width: 900px) { .app-container { grid-template-columns: 1fr; } }
    .panel { background: #fff; border-radius: 24px; border: 1px solid var(--border); padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.04); }
    .panel-header { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; }
    .panel-title { font-size: 18px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
    .criteria-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
    .criterion-card { background: #f8fafc; border: 2px solid transparent; border-radius: 16px; padding: 15px; transition: all 0.2s; position: relative; overflow: hidden; }
    .criterion-card.has-files { border-color: var(--primary); background: #f0f9ff; }
    .c-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
    .c-title { font-size: 13px; font-weight: 700; color: #334155; line-height: 1.5; }
    .c-badge { font-size: 11px; background: #e2e8f0; padding: 3px 8px; border-radius: 6px; height: fit-content; color: #64748b; font-weight: 600; }
    .c-badge.active { background: var(--primary); color: #fff; }
    .drop-zone { border-radius: 12px; background: #fff; border: 2px dashed #cbd5e1; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; }
    .drop-zone:hover { border-color: var(--primary); background: #f0f9ff; }
    .drop-icon { font-size: 24px; display: block; margin-bottom: 5px; color: #94a3b8; }
    .thumbs-container { display: flex; gap: 6px; overflow-x: auto; margin-top: 12px; padding-bottom: 4px; }
    .thumb { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
    .btn-main { width: 100%; background: linear-gradient(135deg, var(--primary), #0284c7); color: #fff; border: none; padding: 16px; border-radius: 16px; font-size: 16px; font-weight: 800; cursor: pointer; box-shadow: 0 8px 20px rgba(14, 165, 233, 0.25); transition: transform 0.2s; margin-top: 25px; display: flex; justify-content: center; align-items: center; gap: 10px; }
    .btn-main:hover { transform: translateY(-2px); }
    .btn-main:disabled { opacity: 0.6; cursor: not-allowed; transform: none; background: #94a3b8; }
    .btn-sec { background: #334155; color: #fff; border: none; padding: 14px; width: 100%; border-radius: 14px; cursor: pointer; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; }
    .qr-list { display: flex; flex-direction: column; gap: 12px; max-height: 500px; overflow-y: auto; }
    .qr-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 16px; display: flex; gap: 15px; align-items: center; transition: 0.2s; }
    .qr-img { width: 70px; height: 70px; background: #fff; padding: 5px; border-radius: 10px; border: 1px solid #e2e8f0; }
    .qr-details { flex: 1; min-width: 0; }
    .qr-name { font-size: 13px; font-weight: 700; margin-bottom: 5px; color: #1e293b; }
    .qr-link { font-size: 11px; color: var(--primary); text-decoration: none; word-break: break-all; display: block; margin-bottom: 8px; }
    .btn-xs { padding: 5px 10px; font-size: 11px; border-radius: 6px; border: none; cursor: pointer; background: #e2e8f0; color: #475569; font-weight: 600; }
    .footer-note { text-align: center; margin-top: 40px; font-size: 13px; color: #94a3b8; font-weight: 500; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="brand">
      <img src="teacher_logo.png" alt="logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2995/2995456.png'">
      <div class="brand-text">
        <h1>Ø§Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p style="font-size:12px; color:var(--primary); font-weight:600">MOE SF2</p>
      </div>
    </div>
    <div class="user-info">
      <span>ğŸ‘¤ <span id="display-username" style="color:var(--primary);font-weight:bold;">...</span></span>
      <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
</header>

<div class="app-container">
  <section class="panel">
    <div class="panel-header">
      <div class="panel-title"><span>ğŸ“‚</span> Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± ÙˆØ§Ù„Ø´ÙˆØ§Ù‡Ø¯</div>
      <div style="font-size:12px; color:#64748b;">Ø§Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª</div>
    </div>
    <div id="criteria-container" class="criteria-grid"></div>
    <button id="btn-generate" class="btn-main" onclick="startGeneration()">
      <span>ğŸš€</span> Ø±ÙØ¹ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯
    </button>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div class="panel-title"><span>ğŸ“Š</span> Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª</div>
    </div>
    <div id="empty-state" style="text-align:center; padding: 50px 0; color: #94a3b8;">
      <div style="font-size:48px; margin-bottom:15px; opacity:0.5;">â˜ï¸</div>
      <p>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„...</p>
    </div>
    <div id="results-area" style="display:none;">
      <div style="background:#dcfce7; color:#166534; padding:10px; border-radius:10px; font-size:13px; margin-bottom:15px; font-weight:600; text-align:center;">
        âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙØ­Ø§Øª Ø¨Ù†Ø¬Ø§Ø­
      </div>
      <div id="qr-list" class="qr-list"></div>
      <div style="margin-top:25px; border-top:2px solid #f1f5f9; padding-top:20px;">
        <button id="btn-pptx" class="btn-sec" onclick="exportPPTX()">
          <span>ğŸ“¥</span> ØªØ­Ù…ÙŠÙ„ PowerPoint
        </button>
      </div>
    </div>
  </section>
</div>

<div class="footer-note">Ù†Ø¸Ø§Ù… Ù…Ù„Ù Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² - MOE SF2</div>

<script>
const user = JSON.parse(sessionStorage.getItem("loggedInUser"));
if (!user) window.location.href = "login.html";
document.getElementById("display-username").textContent = user.username;

// ==========================================
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… - ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
// ==========================================
const CONFIG = {
  // 1. Ø±Ø§Ø¨Ø· Ø§Ù„Ø±ÙØ¹ Ø§Ù„ØµØ­ÙŠØ­ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ your-name Ø¨Ù€ snh-saud)
  uploaderUrl: "https://moe-uploader.snh-saud.workers.dev/", 
  
  // 2. Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ MOE-SF2
  baseUrl: "https://xsf3x.github.io/MOE-SF2", 
  
  // 3. Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯
  teacherFolder: "TEACHERS", 

  criteria: [
    "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ : Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ©",
    "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ : Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ù…Ù‡Ù†ÙŠ",
    "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø« : Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±",
    "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹ : Ø§Ù„ØªÙ†ÙˆÙŠØ¹ ÙÙŠ Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³",
    "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø®Ø§Ù…Ø³ : ØªØ­Ø³ÙŠÙ† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ†",
    "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¯Ø³ : Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªÙ†ÙÙŠØ° Ø®Ø·Ø© Ø§Ù„ØªØ¹Ù„Ù…",
    "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¨Ø¹ : ØªÙˆØ¸ÙŠÙ ØªÙ‚Ù†ÙŠØ§Øª ÙˆÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©",
    "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù…Ù† : ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©",
    "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„ØªØ§Ø³Ø¹ : Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙŠØ©",
    "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ø´Ø± : ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ†",
    "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø± : ØªÙ†ÙˆØ¹ Ø£Ø³Ø§Ù„ÙŠØ¨ ÙˆØ£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ‚ÙˆÙŠÙ…",
    "Ù…Ù†Ø¬Ø²Ø§Øª Ø£Ø®Ø±Ù‰ Ø®Ù„Ø§Ù„ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù¡Ù¤Ù¤Ù§Ù‡Ù€"
  ]
};

let appState = { selectedFiles: {}, generatedQR: [] };

function init() {
  const container = document.getElementById("criteria-container");
  container.innerHTML = "";
  CONFIG.criteria.forEach((name, index) => {
    const id = index + 1;
    appState.selectedFiles[id] = [];
    const card = document.createElement("div");
    card.className = "criterion-card";
    card.id = `card-${id}`;
    card.innerHTML = `
      <div class="c-header"><div class="c-title">${name}</div><div class="c-badge" id="badge-${id}">0</div></div>
      <div class="drop-zone" onclick="document.getElementById('file-${id}').click()">
        <input type="file" id="file-${id}" multiple accept="image/*" style="display:none" onchange="handleFileSelect(${id}, this)">
        <span class="drop-icon">ğŸ“·</span>
      </div>
      <div class="thumbs-container" id="thumbs-${id}"></div>
    `;
    const dz = card.querySelector('.drop-zone');
    dz.addEventListener('dragover', e => { e.preventDefault(); dz.style.borderColor = 'var(--primary)'; dz.style.background = '#f0f9ff'; });
    dz.addEventListener('dragleave', e => { e.preventDefault(); dz.style.borderColor = '#cbd5e1'; dz.style.background = '#fff'; });
    dz.addEventListener('drop', e => {
      e.preventDefault(); dz.style.borderColor = '#cbd5e1'; dz.style.background = '#fff';
      if(e.dataTransfer.files.length) addFiles(id, e.dataTransfer.files);
    });
    container.appendChild(card);
  });
}

function handleFileSelect(id, input) { if(input.files.length) addFiles(id, input.files); }
function addFiles(id, fileList) {
  appState.selectedFiles[id] = [...appState.selectedFiles[id], ...Array.from(fileList)];
  updateCardUI(id);
}

function updateCardUI(id) {
  const files = appState.selectedFiles[id];
  document.getElementById(`badge-${id}`).textContent = files.length;
  document.getElementById(`badge-${id}`).classList.toggle("active", files.length > 0);
  document.getElementById(`card-${id}`).classList.toggle("has-files", files.length > 0);
  const thumbs = document.getElementById(`thumbs-${id}`);
  thumbs.innerHTML = "";
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => { const img = document.createElement("img"); img.src = e.target.result; img.className = "thumb"; thumbs.appendChild(img); };
    reader.readAsDataURL(file);
  });
}

async function startGeneration() {
  const filledIds = Object.keys(appState.selectedFiles).filter(id => appState.selectedFiles[id].length > 0);
  if (!filledIds.length) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹', 'info');

  const safeName = user.username.replace(/[^a-zA-Z0-9\u0600-\u06FF\s_-]/g, "").trim().replace(/\s+/g, "-");
  const uploadPathPrefix = `docs/${CONFIG.teacherFolder}/${safeName}`;

  if(!await Swal.fire({ title: 'Ù‡Ù„ Ø£Ù†Øª Ø¬Ø§Ù‡Ø²ØŸ', text: `Ø³ÙŠØªÙ… Ø§Ù„Ø±ÙØ¹ Ù„Ù€ ${filledIds.length} Ù…Ø¹ÙŠØ§Ø±`, icon: 'question', showCancelButton: true, confirmButtonText: 'Ø§Ø¨Ø¯Ø£', confirmButtonColor: 'var(--primary)' }).then(r=>r.isConfirmed)) return;

  const btn = document.getElementById("btn-generate");
  btn.disabled = true;
  appState.generatedQR = [];

  Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...', html: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ¹Ø¯Ù… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©', didOpen: () => Swal.showLoading() });

  try {
    // 1. Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ØªÙƒÙˆÙŠÙ†
    await githubUpload("docs/_config.yml", `include:\n  - "**/*.html"\n`);

    // 2. Ø±ÙØ¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±
    for (const id of filledIds) {
      const files = appState.selectedFiles[id];
      const critName = CONFIG.criteria[id - 1];
      Swal.update({ html: `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹: <b>${critName}</b>` });

      const imgs = await Promise.all(files.map(async f => {
        const b64 = await fileToDataURL(f);
        return `<div class="img-box"><img src="${b64}" loading="lazy"/></div>`;
      }));

      const pageHtml = `<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>${user.username}</title><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet"><style>body{font-family:'Tajawal',sans-serif;background:#f8fafc;color:#1e293b;padding:20px}header{background:#fff;padding:20px;border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,0.05);text-align:center;margin-bottom:20px}h1{margin:0;font-size:20px;color:#0ea5e9}.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px}.img-box{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,0.05);border:1px solid #e2e8f0}.img-box img{width:100%;display:block}</style></head><body><header><h1>${critName}</h1><p>Ø§Ù„Ù…Ø¹Ù„Ù…: ${user.username}</p></header><div class="grid">${imgs.join('')}</div></body></html>`;

      // Ø§Ù„Ø±ÙØ¹
      await githubUpload(`${uploadPathPrefix}/criterion-${id}.html`, pageHtml);

      // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· (Ø¨Ø¯ÙˆÙ† docs)
      const publicUrl = `${CONFIG.baseUrl}/${CONFIG.teacherFolder}/${safeName}/criterion-${id}.html`;
      
      const qrData = await QRCode.toDataURL(publicUrl, { width: 400, margin: 1, color: { dark: "#0f172a", light: "#ffffff" } });
      appState.generatedQR.push({ id, name: critName, url: publicUrl, base64: qrData });
    }

    Swal.fire('ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·', 'success');
    renderResults();
  } catch (e) {
    console.error(e);
    Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ' + e.message, 'error');
  } finally { btn.disabled = false; }
}

function renderResults() {
  document.getElementById("empty-state").style.display = "none";
  document.getElementById("results-area").style.display = "block";
  const list = document.getElementById("qr-list");
  list.innerHTML = "";
  appState.generatedQR.forEach(item => {
    const el = document.createElement("div");
    el.className = "qr-item";
    el.innerHTML = `
      <img src="${item.base64}" class="qr-img">
      <div class="qr-details">
        <div class="qr-name">${item.name}</div>
        <a href="${item.url}" target="_blank" class="qr-link">${item.url}</a>
        <div><button class="btn-xs" onclick="copyLink('${item.url}')">Ù†Ø³Ø®</button> <button class="btn-xs" onclick="window.open('${item.url}')">ÙØªØ­</button></div>
      </div>
    `;
    list.appendChild(el);
  });
}

function copyLink(t){ navigator.clipboard.writeText(t); const Toast=Swal.mixin({toast:true,position:'top-end',showConfirmButton:false,timer:1000}); Toast.fire({icon:'success',title:'ØªÙ… Ø§Ù„Ù†Ø³Ø®'}); }

async function exportPPTX() {
  if (!appState.generatedQR.length) return;
  const { value: form } = await Swal.fire({
    title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºÙ„Ø§Ù',
    html: `<input id="sw-name" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…"><input id="sw-mgr" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±"><input id="sw-sch" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">`,
    preConfirm: () => [document.getElementById('sw-name').value, document.getElementById('sw-mgr').value, document.getElementById('sw-sch').value]
  });
  if (!form || !form[0]) return;
  
  Swal.showLoading();
  try {
    const zip = await JSZip.loadAsync(await (await fetch("template.pptx")).arrayBuffer());
    const replaceTxt = async (s, r) => {
      for (const f of Object.keys(zip.files).filter(k => k.startsWith("ppt/slides/") && k.endsWith(".xml"))) {
        zip.file(f, (await zip.file(f).async("string")).split(s).join(r));
      }
    };
    await replaceTxt("âˆ‘", form[0]); await replaceTxt("âˆ", form[1]); await replaceTxt("âˆ†", form[2]);

    for (let i = 0; i < appState.generatedQR.length; i++) {
        const slideNum = 8 + i; 
        const slidePath = `ppt/slides/slide${slideNum}.xml`;
        if (zip.file(slidePath)) {
            const b64 = appState.generatedQR[i].base64.split(",")[1];
            const imgName = `qr_${i}.png`;
            const relId = `rId_QR_${i}`;
            zip.file(`ppt/media/${imgName}`, b64, { base64: true });
            const relPath = `ppt/slides/_rels/slide${slideNum}.xml.rels`;
            let relXml = zip.file(relPath) ? await zip.file(relPath).async("string") : `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"></Relationships>`;
            if(!relXml.includes(relId)) {
                relXml = relXml.replace("</Relationships>", `<Relationship Id="${relId}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="../media/${imgName}"/></Relationships>`);
                zip.file(relPath, relXml);
            }
            let sXml = await zip.file(slidePath).async("string");
            const pic = `<p:pic xmlns:p="http://schemas.openxmlformats.org/presentationml/2006/main" xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"><p:nvPicPr><p:cNvPr id="99${i}" name="QR${i}"/><p:cNvPicPr><a:picLocks noChangeAspect="1"/></p:cNvPicPr><p:nvPr/></p:nvPicPr><p:blipFill><a:blip r:embed="${relId}"/><a:stretch><a:fillRect/></a:stretch></p:blipFill><p:spPr><a:xfrm><a:off x="6217920" y="4251840"/><a:ext cx="2421600" cy="2421600"/></a:xfrm><a:prstGeom prst="rect"><a:avLst/></a:prstGeom></p:spPr></p:pic>`;
            sXml = sXml.replace("</p:spTree>", pic + "</p:spTree>");
            zip.file(slidePath, sXml);
        }
    }
    saveAs(await zip.generateAsync({ type: "blob" }), `Ù…Ù„Ù-Ø¥Ù†Ø¬Ø§Ø²-${form[0]}.pptx`);
    Swal.fire('ØªÙ…', 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù', 'success');
  } catch(e) { Swal.fire('Ø®Ø·Ø£', e.message, 'error'); }
}

async function githubUpload(path, content) {
  const res = await fetch(CONFIG.uploaderUrl, { 
    method: "POST", 
    headers: { "Content-Type": "application/json" }, 
    body: JSON.stringify({ path, content }) 
  });
  if (!res.ok) {
     const errorText = await res.text();
     throw new Error(`Error ${res.status}: ${errorText}`);
  }
}

function fileToDataURL(f) { return new Promise((r, j) => { const fr = new FileReader(); fr.onload = () => r(fr.result); fr.onerror = j; fr.readAsDataURL(f); }); }
function logout() { sessionStorage.removeItem("loggedInUser"); window.location.href = "login.html"; }

init();
</script>
</body>
</html>


